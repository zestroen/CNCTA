// ==UserScript==
// @name         CnC Translator (EN/DE â†’ RU Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ)
// @namespace    http://tampermonkey.net/
// @version      3.0
// @description  ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ñ‚ Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ñ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¾Ð³Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÐ¼ÐµÑ†ÐºÐ¾Ð³Ð¾ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¸Ð¹ Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ
// @author       zestroen
// @match        *://*.alliances.commandandconquer.com/*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  function addTranslationButtons() {
    const container = document.createElement("div");
    container.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: #222;
      color: #fff;
      padding: 8px;
      border-radius: 8px;
      z-index: 9999;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      gap: 5px;
      user-select: none;
    `;

    const enBtn = document.createElement("div");
    enBtn.textContent = "EN";
    enBtn.title = "ÐŸÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ñ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¾Ð³Ð¾";
    enBtn.style.cssText = `
      background: #444;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
    `;

    const deBtn = document.createElement("div");
    deBtn.textContent = "ðŸ‡©ðŸ‡ª";
    deBtn.title = "ÐŸÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ñ Ð½ÐµÐ¼ÐµÑ†ÐºÐ¾Ð³Ð¾";
    deBtn.style.cssText = `
      background: #444;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
    `;

    // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
    async function translateSelectedText(lang) {
      const selectedText = window.getSelection().toString().trim();
      if (!selectedText) {
        alert("â— Ð’Ñ‹Ð´ÐµÐ»Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°.");
        return;
      }

      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${lang}&tl=ru&dt=t&q=${encodeURIComponent(selectedText)}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        const translated = json[0].map(item => item[0]).join("") || "[Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸]";
        alert(`ðŸ” ÐŸÐµÑ€ÐµÐ²Ð¾Ð´:\n${translated}`);
      } catch (e) {
        alert("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ðµ.");
        console.error("Translation error:", e);
      }
    }

    enBtn.onclick = () => translateSelectedText("en");
    deBtn.onclick = () => translateSelectedText("de");

    // ÐŸÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ
    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    container.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - container.offsetLeft;
      offsetY = e.clientY - container.offsetTop;
      container.style.cursor = "grabbing";
    });

    document.addEventListener("mousemove", (e) => {
      if (isDragging) {
        container.style.left = `${e.clientX - offsetX}px`;
        container.style.top = `${e.clientY - offsetY}px`;
        container.style.right = "auto";
      }
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      container.style.cursor = "default";
    });

    container.appendChild(enBtn);
    container.appendChild(deBtn);
    document.body.appendChild(container);
  }

  window.addEventListener("load", () => {
    setTimeout(() => {
      addTranslationButtons();
    }, 3000);
  });
})();
