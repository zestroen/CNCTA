// ==UserScript==
// @name         CnC Chat Translator (EN/DE â†’ RU + Ð’Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚)
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ñ‚ Ñ‡Ð°Ñ‚ Ñ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¾Ð³Ð¾ Ð¸ Ð½ÐµÐ¼ÐµÑ†ÐºÐ¾Ð³Ð¾ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¸Ð¹ + Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð² C&C: Tiberium Alliances
// @author       zestroen
// @match        *://*.alliances.commandandconquer.com/*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  let translationEnabled = true;
  const queue = [];

  function addToggleButton() {
    const container = document.createElement("div");
    container.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: #222;
      color: #fff;
      padding: 8px;
      border-radius: 8px;
      z-index: 9999;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      gap: 5px;
      user-select: none;
    `;

    const toggleBtn = document.createElement("div");
    toggleBtn.textContent = "ðŸ” ÐŸÐµÑ€ÐµÐ²Ð¾Ð´: Ð’ÐšÐ›";
    toggleBtn.style.cssText = `
      background: #444;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: move;
      text-align: center;
    `;

    const translateSelectionBtn = document.createElement("div");
    translateSelectionBtn.textContent = "ðŸ“„ ÐŸÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ð¾Ðµ";
    translateSelectionBtn.style.cssText = `
      background: #444;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
    `;

    // ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°
    translateSelectionBtn.onclick = async () => {
      const selectedText = window.getSelection().toString().trim();
      if (!selectedText) {
        alert("â— Ð’Ñ‹Ð´ÐµÐ»Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°.");
        return;
      }
      const translated = await smartTranslate(selectedText);
      alert(`ðŸ” ÐŸÐµÑ€ÐµÐ²Ð¾Ð´:\n${translated}`);
    };

    // ÐŸÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ Ð±Ð»Ð¾ÐºÐ°
    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    toggleBtn.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - container.offsetLeft;
      offsetY = e.clientY - container.offsetTop;
      toggleBtn.style.cursor = "grabbing";
    });

    document.addEventListener("mousemove", (e) => {
      if (isDragging) {
        container.style.left = `${e.clientX - offsetX}px`;
        container.style.top = `${e.clientY - offsetY}px`;
        container.style.right = "auto";
      }
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      toggleBtn.style.cursor = "move";
    });

    // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
    toggleBtn.onclick = () => {
      if (isDragging) return;
      translationEnabled = !translationEnabled;
      toggleBtn.textContent = "ðŸ” ÐŸÐµÑ€ÐµÐ²Ð¾Ð´: " + (translationEnabled ? "Ð’ÐšÐ›" : "Ð’Ð«ÐšÐ›");
    };

    container.appendChild(toggleBtn);
    container.appendChild(translateSelectionBtn);
    document.body.appendChild(container);
  }

  function scanChat() {
    if (!translationEnabled) return;

    const chatDivs = document.querySelectorAll('div[style*="word-wrap: break-word"]');
    chatDivs.forEach(div => {
      if (div.querySelector(".translatedText")) return;

      const spanList = div.querySelectorAll("span");
      const textSpan = spanList[spanList.length - 1];
      if (!textSpan || !textSpan.textContent.trim()) return;

      const originalText = textSpan.textContent.trim();
      if (/[Ð°-ÑÐ-Ð¯Ñ‘Ð]/.test(originalText)) return;

      const translatedLine = document.createElement("span");
      translatedLine.className = "translatedText";
      translatedLine.style.display = "block";
      translatedLine.style.color = "#00cc66";
      translatedLine.style.fontSize = "11px";
      translatedLine.style.opacity = "0.8";
      translatedLine.textContent = "â³ ÐŸÐµÑ€ÐµÐ²Ð¾Ð´...";

      const fontContainer = div.querySelector("font:last-of-type");
      if (fontContainer) {
        fontContainer.appendChild(translatedLine);
        queue.push({
          el: translatedLine,
          original: originalText
        });
      }
    });
  }

  async function smartTranslate(text) {
    const tryTranslate = async (lang) => {
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${lang}&tl=ru&dt=t&q=${encodeURIComponent(text)}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        return json[0].map(item => item[0]).join("") || text;
      } catch (e) {
        console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° (${lang}):`, e);
        return text;
      }
    };

    const ruRegex = /[Ð°-ÑÐ-Ð¯Ñ‘Ð]/;
    if (ruRegex.test(text)) return text;

    const resultEN = await tryTranslate("en");
    if (resultEN.toLowerCase() !== text.toLowerCase()) return resultEN;

    const resultDE = await tryTranslate("de");
    if (resultDE.toLowerCase() !== text.toLowerCase()) return resultDE;

    return "[Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸]";
  }

  async function processQueue() {
    if (queue.length === 0) return;
    const item = queue.shift();
    const translated = await smartTranslate(item.original);
    item.el.textContent = translated;
  }

  function watchChat() {
    setInterval(() => {
      scanChat();
      processQueue();
    }, 1000);
  }

  window.addEventListener("load", () => {
    setTimeout(() => {
      addToggleButton();
      watchChat();
    }, 3000);
  });

})();
