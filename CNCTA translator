// ==UserScript==
// @name         CnC Translator (EN/DE → RU по кнопке)
// @namespace    http://tampermonkey.net/
// @version      3.0
// @description  Переводит выделенный текст с английского или немецкого на русский по кнопке
// @author       zestroen
// @match        *://*.alliances.commandandconquer.com/*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  function addTranslationButtons() {
    const container = document.createElement("div");
    container.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: #222;
      color: #fff;
      padding: 8px;
      border-radius: 8px;
      z-index: 9999;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      gap: 5px;
      user-select: none;
    `;

    const enBtn = document.createElement("div");
    enBtn.textContent = "EN";
    enBtn.title = "Перевести с английского";
    enBtn.style.cssText = `
      background: #444;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
    `;

    const deBtn = document.createElement("div");
    deBtn.textContent = "🇩🇪";
    deBtn.title = "Перевести с немецкого";
    deBtn.style.cssText = `
      background: #444;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
    `;

    // Функция перевода
    async function translateSelectedText(lang) {
      const selectedText = window.getSelection().toString().trim();
      if (!selectedText) {
        alert("❗ Выделите текст для перевода.");
        return;
      }

      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${lang}&tl=ru&dt=t&q=${encodeURIComponent(selectedText)}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        const translated = json[0].map(item => item[0]).join("") || "[не удалось перевести]";
        alert(`🔁 Перевод:\n${translated}`);
      } catch (e) {
        alert("❌ Ошибка при переводе.");
        console.error("Translation error:", e);
      }
    }

    enBtn.onclick = () => translateSelectedText("en");
    deBtn.onclick = () => translateSelectedText("de");

    // Перетаскивание
    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    container.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - container.offsetLeft;
      offsetY = e.clientY - container.offsetTop;
      container.style.cursor = "grabbing";
    });

    document.addEventListener("mousemove", (e) => {
      if (isDragging) {
        container.style.left = `${e.clientX - offsetX}px`;
        container.style.top = `${e.clientY - offsetY}px`;
        container.style.right = "auto";
      }
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      container.style.cursor = "default";
    });

    container.appendChild(enBtn);
    container.appendChild(deBtn);
    document.body.appendChild(container);
  }

  window.addEventListener("load", () => {
    setTimeout(() => {
      addTranslationButtons();
    }, 3000);
  });
})();
